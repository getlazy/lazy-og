# lazy-taskrun-engine
Engine capable of running simple tasks from external NPMs

The engine that is capable of downloading task implementation during the boot, and executing it from lazy pipeline.

There can be one task loaded in this engine. It must be a NPM package that can be installed via `npm install` command.

## Task Engine
 
To configure this engine, put the following lines in the `engines` section of `lazy.yaml`:

```
engines:
  taskEngine:
    image: getlazy/taskrun-engine:latest
	boot_wait: true # optional, defaults to true, flag instructing lazy to wait for engine's boot process to finish
	boot_timeout: 120 # optional timeout to wait for engine to boot
	meta: {} # optional metadata for the engine, if not provided lazy queries the engine for it

	config:
	  task: 'npm-neb-test1' # npm-package-name:version or just npm-package-name
	  # task: 'npm-neb-test1:latest'
	  # task: 'npm-neb-test1:3.2.1'
```

Then, you can use `task1` and `task2` in engine pipline in `lazy.yaml`:

```
engine_pipeline:
	- sequence:               
	  - taskEngine:        # Engine name
		 taskConfig:       # Optional config for this task
            prop1: 'val1'  #  =||=
         prop2: 'val2'     #  =||=
```
## Task Modules

Each task that you wish to use with this engine should be implemented as a simple Node.js module that exports just one function:

`executeLazy (hostPath, language, content, context)`

This function should return promise resolving with the results of task.

Here is the minimal example of a task implementation:

```
'use strict';

const executeLazy = (hostPath, language, content, context) => {
	 return new Promise((resolve) => {
		// The output from previos task or engine in the pipeline, if any,
		// will be stored in context.previousStepResults
		const prevTasksResults = context.previousStepResults;

		// If you need to access the task configuration from the lazy.yaml file,
		// you can reach it through context.engineParams property:
		const taskConfig = context.engineParams.taskConfig;
		const prop2 = context.engineParams.prop2;

		const newResults = [];
		// ... do somehing and store results in newResults ...

		// Note:
		// Results from previos task or engine in pipeline are _not_ included in response.
		// If you wish to pass on the resuls from previous step,
		// you need to copy them manually from context.previousStepResults to newResults. If
		// you just resolve([]) you will delete any results generated by previous engines.
		 
		resolve(newResults);
	});
}

module.exports = {
    executeLazy
};

```